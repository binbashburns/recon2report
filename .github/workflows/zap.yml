name: ZAP Scan

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  zap-scan:
    name: Enhanced ZAP Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Required for PR comments
    env:
      API_PROJECT: R2R.Api/R2R.Api.csproj
      API_PORT: 5258
      API_URL: http://host.docker.internal:5258
      HEALTH_PATH: /health
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      - name: Build
        run: dotnet build --configuration Release

      - name: Start API (background)
        run: |
          nohup dotnet run --project "${{ env.API_PROJECT }}" --urls "http://0.0.0.0:${{ env.API_PORT }}" > api.log 2>&1 &
          echo $! > api.pid

      - name: Wait for API readiness
        run: |
          for i in {1..40}; do
            if curl -fsS "http://localhost:${{ env.API_PORT }}${{ env.HEALTH_PATH }}" >/dev/null; then
              echo "API ready"
              exit 0
            fi
            echo "Waiting for API..."
            sleep 3
          done
          echo "API did not become ready"
          cat api.log || true
          exit 1

      - name: Run comprehensive ZAP scans
        run: |
          mkdir -p zap-reports
          chmod 777 zap-reports
          
          # Baseline scan
          docker run --rm \
            --add-host=host.docker.internal:host-gateway \
            -v "$(pwd)/zap-reports:/zap/wrk:rw" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t "${{ env.API_URL }}" \
              -O "${{ env.API_URL }}/swagger/v1/swagger.json" \
              -r baseline-report.html \
              -j baseline-report.json \
              -d -I || true
          
          # API-specific scan
          docker run --rm \
            --add-host=host.docker.internal:host-gateway \
            -v "$(pwd)/zap-reports:/zap/wrk:rw" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-api-scan.py \
              -t "${{ env.API_URL }}/swagger/v1/swagger.json" \
              -f openapi \
              -r api-scan-report.html \
              -J api-scan-report.json \
              -d || true

      - name: Create enhanced PR comment with scan results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            function processZapReport(filePath, scanType) {
              try {
                const report = JSON.parse(fs.readFileSync(filePath, 'utf8'));
                const alerts = report.site?.[0]?.alerts || [];
                
                const counts = { High: 0, Medium: 0, Low: 0, Informational: 0 };
                const details = [];
                
                alerts.forEach(alert => {
                  const risk = alert.riskdesc.split(' ')[0];
                  const instanceCount = alert.instances?.length || 0;
                  counts[risk] = (counts[risk] || 0) + instanceCount;
                  
                  if (instanceCount > 0) {
                    details.push({
                      name: alert.name,
                      risk: risk,
                      count: instanceCount,
                      description: alert.desc.substring(0, 150) + '...'
                    });
                  }
                });
                
                return { counts, details, scanType };
              } catch (error) {
                console.log(`Could not process ${scanType} report:`, error.message);
                return null;
              }
            }
            
            // Process reports
            const baselineResults = processZapReport('zap-reports/baseline-report.json', 'Baseline');
            const apiResults = processZapReport('zap-reports/api-scan-report.json', 'API');
            
            // Create comprehensive comment
            let comment = `## âš¡ï¸ ZAP Security Scan Results\n\n`;
            comment += `**Scan completed:** ${new Date().toLocaleString()}\n`;
            comment += `**Target:** \`${{ env.API_URL }}\`\n\n`;
            
            if (baselineResults || apiResults) {
              comment += `### ğŸ“Š Summary\n\n`;
              
              if (baselineResults) {
                comment += `**Baseline Scan:**\n`;
                comment += `ğŸ”´ High: ${baselineResults.counts.High} | `;
                comment += `ğŸŸ  Medium: ${baselineResults.counts.Medium} | `;
                comment += `ğŸŸ¡ Low: ${baselineResults.counts.Low} | `;
                comment += `â„¹ï¸ Info: ${baselineResults.counts.Informational}\n\n`;
              }
              
              if (apiResults) {
                comment += `**API Scan:**\n`;
                comment += `ğŸ”´ High: ${apiResults.counts.High} | `;
                comment += `ğŸŸ  Medium: ${apiResults.counts.Medium} | `;
                comment += `ğŸŸ¡ Low: ${apiResults.counts.Low} | `;
                comment += `â„¹ï¸ Info: ${apiResults.counts.Informational}\n\n`;
              }
              
              // Show high/medium alerts in detail
              const criticalAlerts = [];
              [baselineResults, apiResults].filter(Boolean).forEach(result => {
                result.details.forEach(alert => {
                  if (alert.risk === 'High' || alert.risk === 'Medium') {
                    criticalAlerts.push({ ...alert, source: result.scanType });
                  }
                });
              });
              
              if (criticalAlerts.length > 0) {
                comment += `### âš ï¸ Critical Issues Found\n\n`;
                criticalAlerts.forEach(alert => {
                  const emoji = alert.risk === 'High' ? 'ğŸ”´' : 'ğŸŸ ';
                  comment += `**${emoji} ${alert.name}** (${alert.source} scan)\n`;
                  comment += `${alert.description}\n\n`;
                });
              } else {
                comment += `### âœ… No Critical Issues Found\n\n`;
                comment += `Great! No high or medium risk vulnerabilities detected.\n\n`;
              }
            } else {
              comment += `âš ï¸ Could not parse scan results. Please check the workflow artifacts.\n\n`;
            }
            
            comment += `### ğŸ“‹ Full Reports\n`;
            comment += `- ğŸ“Š **HTML Reports:** [Download ZAP Security Reports](${context.payload.repository.html_url}/actions/runs/${context.runId}#artifacts)\n`;
            comment += `- ğŸ“„ **API Logs:** [Download API Logs](${context.payload.repository.html_url}/actions/runs/${context.runId}#artifacts)\n`;
            comment += `- ğŸ”— **Workflow Details:** [View complete run](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            comment += `- ğŸ“– **Learn More:** [OWASP ZAP Documentation](https://www.zaproxy.org/docs/)\n\n`;
            comment += `<details>\n`;
            comment += `<summary>ğŸ“¦ Available Artifacts</summary>\n\n`;
            comment += `- \`zap-security-reports\` - Contains baseline-report.html, api-scan-report.html, and JSON reports\n`;
            comment += `- \`api-logs\` - API startup and runtime logs\n\n`;
            comment += `Click the artifacts link above to download these files.\n`;
            comment += `</details>`;
            
            // Post the comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload all ZAP reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-reports
          path: zap-reports/

      - name: Upload API logs
        uses: actions/upload-artifact@v4
        with:
          name: api-logs
          path: api.log